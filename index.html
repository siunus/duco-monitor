<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'/>
		<meta http-equiv='X-UA-Compatible' content='IE=edge'/>
		<title>DUCO Monitor | by siunusdev.com</title>
		<meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'/>
		<link rel='shortcut icon' href='favicon.ico'/>
		<link rel='stylesheet' href='plugins/bootstrap/dist/css/bootstrap.min.css'/>
		<link rel='stylesheet' href='plugins/font-awesome/css/font-awesome.min.css'/>
		<link rel='stylesheet' href='dist/css/AdminLTE.min.css'/>
		<link rel='stylesheet' href='dist/css/skins/skin-blue.min.css'/>
		<link rel='stylesheet' href='dist/css/axkjfkdfhk.css'/>
		<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic'/>
		
		<!--[if lt IE 9]>
		<script src='https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js'></script>
		<script src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js'></script>
		<![endif]-->
	</head>
	<body class='hold-transition skin-blue layout-top-nav'>

		<div class='wrapper'>

			<header class="main-header">
				<nav class="navbar navbar-static-top">
					<div class="container">
						<div class="navbar-header">
							<a href="" class="navbar-brand"><b>DUCO</b>Monitor</a>
							<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
								<i class="fa fa-bars"></i>
							</button>
						</div>

						<div class="collapse navbar-collapse pull-left" id="navbar-collapse">
							<ul class="nav navbar-nav">
								<li class="active"><a href="">Monitor <span class="sr-only">(current)</span></a></li>
								<li><a href="https://revoxhere.github.io/duco-exchange/" target='_blank'>DUCO Exchange</a></li>
								<li><a href="http://www.node-s.co.za/duco_exchange/home" target='_blank'>Node-S Exchange</a></li>
							</ul>
						</div>
						
						<div class="navbar-custom-menu">
							<ul class="nav navbar-nav">
								
								<li class="dropdown messages-menu">
									
									<a href="#" class="dropdown-toggle">
										<i class="fa fa-clock-o"></i> <span id='time-bar'>00:00:00</span>
									</a>
								</li>
								
								<li class="dropdown user user-menu">
									<!-- Menu Toggle Button -->
									<a href="#" class="dropdown-toggle" data-toggle="dropdown">
										<!-- The user image in the navbar-->
										<img src="dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
										<!-- hidden-xs hides the username on small devices so only the image appears. -->
										<span class="hidden-xs" id="duco-user">&nbsp;</span>
									</a>
									<ul class="dropdown-menu">
										<!-- The user image in the menu -->
										<li class="user-header">
											<img src="dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">

											<p>
												<small>Change duco username by adding hash #username to the end of URL</small>
											</p>
										</li>
									</ul>
								</li>
							</ul>
						</div>
						<!-- /.navbar-custom-menu -->
					</div>
					<!-- /.container-fluid -->
				</nav>
			</header>

			<div class="content-wrapper">
				<div class="container">
					<section class="content-header hidden-lg hidden-md hidden-sm">
						<ol class="breadcrumb">
							<li><a href="#"><i class="fa fa-database"></i> CPU: <span id='stat-cpu'>-</span></a></li>
							<li><a href="#">RAM: <span id='stat-ram'>-</span></a></li>
							<li><a href="#">Active Connections: <span id='stat-conn'>-</span></a></li>
						</ol>
					</section>

					<section class="content">
				
						<div class="row">
							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-aqua"><i class="fa fa-sitemap"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">Active Workers</span>
										<span class="info-box-number"><span id='counter-worker'>-</span></span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->
							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-red"><i class="fa fa-dollar"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">DUCO Price</span>
										<span class="info-box-number"><span id='counter-price'>-</span></span>
										<span class="info-box-text"><span id='counter-price-change'></span></span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->

							<div class="clearfix visible-sm-block"></div>

							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-yellow"><i class="fa fa-money"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">Estimated Profit</span>
										<span class="info-box-number"><span id='counter-estprofit'>-</span></span>
										<span class="info-box-text">24 Hours</span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->
							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-green"><i class="fa fa-money"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">DUCO Balance</span>
										<span class="info-box-number"><span id='counter-balance'>-</span></span>
										<span class="info-box-text"><span id='counter-dollar'></span></span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->
						</div>
						
						<div class='row'>
							<div class='col-md-12'>
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-line-chart fa-fw'></i> &nbsp;Price Change History</h3>
									</div>
									<div class="box-body">
										<div class='row'>
											<div class='col-md-10'></div>
											<div class='col-md-2'>
												<i class='fa fa-fw fa-caret-up text-green'></i> Max: <span id='price-max'>-</span><br/>
												<i class='fa fa-fw fa-caret-down text-red'></i> Min: <span id='price-min'>-</span><br/>
												<i class='fa fa-fw fa-arrows-h text-yellow'></i> Avg: <span id='price-avg'>-</span><br/>
											</div>
										</div>
										<br/>
										<canvas id='priceChart' style='height:200px;width:100%;'></canvas>
									</div>
								</div>
							</div>
						</div>
						
						<div class='row'>
							<div class='col-md-12'>
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-line-chart fa-fw'></i> &nbsp;Coins are Mined</h3>
									</div>
									<div class="box-body">
										<div class='row'>
											<div class='col-md-10'></div>
											<div class='col-md-2'>
												<i class='fa fa-fw fa-caret-up text-green'></i> Max: <span id='coins-max'>-</span><br/>
												<i class='fa fa-fw fa-caret-down text-red'></i> Min: <span id='coins-min'>-</span><br/>
												<i class='fa fa-fw fa-arrows-h text-yellow'></i> Avg: <span id='coins-avg'>-</span><br/>
											</div>
										</div>
										<br/>
										<canvas id='coinsChart' style='height:200px;width:100%;'></canvas>
									</div>
								</div>
							</div>
						</div>
						
						<div class='row'>
							<div class='col-md-12'>
							
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-diamond fa-fw'></i> &nbsp;My Miners</h3>
									</div>
									<!-- /.box-header -->
									<div class="box-body table-responsive no-padding">
										<table class='table' id='tbl-miners'>
											<thead>
												<tr>
													<th width='20px'>#</th>
													<th>Software</th>
													<th>Sharetime</th>
													<th>Accepted</th>
													<th>Rejected</th>
													<th>Hashrate</th>
													<th>Diff</th>
													<th>Identifier</th>
													<th>Last Share Timestamp</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td></td>
													<td>Loading...</td>
													<td></td>
													<td></td>
													<td></td>
													<td></td>
													<td></td>
													<td></td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- /.footer -->
								</div>
								<!-- /.box -->
							
							</div>
						</div>
						
						<div class='row'>
							<div class='col-md-6'>
							
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-fw fa-trophy'></i> &nbsp;Top 10</h3>
									</div>
									<!-- /.box-header -->
									<div class="box-body table-responsive no-padding">
										<table class='table' id='tbl-top10'>
											<thead>
												<tr>
													<th width='20px'>#</th>
													<th>Balance</th>
													<th>Username</th>
													<th>Workers</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td></td>
													<td>Loading...</td>
													<td></td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- /.footer -->
								</div>
							</div>
								
							
							<div class='col-md-6'>
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-fw fa-retweet'></i> &nbsp;Last Transactions</h3>
									</div>
									<!-- /.box-header -->
									<div class="box-body table-responsive no-padding">
										<table class='table' id='tbl-transactions'>
											<thead>
												<tr>
													<th width='20px'>#</th>
													<th>Date/Time</th>
													<th>Sender</th>
													<th>Recipient</th>
													<th>Amount</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td></td>
													<td>Loading...</td>
													<td></td>
													<td></td>
													<td></td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- /.footer -->
								</div>
								<!-- /.box -->
						</div>
						
					</section>
				<!-- /.content -->
				</div>
			</div>
			
			<footer class="main-footer">
				<div class="container">
					<div class="pull-right hidden-xs">
						<a href="https://github.com/siunus/duco-monitor" title='Github' target='_blank'><i class='fa fa-github text-black'></i></a> &nbsp;&nbsp;&nbsp; 
						<a href="https://www.instagram.com/siunus_id" title='Follow me on Instagram' target='_blank'><i class='fa fa-instagram text-red'></i></a> 
					</div>
					<a href="https://www.siunusdev.com" title='My Website' target='_blank'>SIUNUSDEV</a> &nbsp;&middot;&nbsp; 
					<a href="https://duinocoin.com" title='Duino-Coin' target='_blank'>Duino-Coin</a> &nbsp;&middot;&nbsp; 
					<a href="https://adminlte.io" title='Theme' target='_blank'>AdminLTE.io</a>
				</div>
			</footer>
			
		</div>
		
		<script src='plugins/jquery/dist/jquery.min.js'></script>
		<script src='plugins/bootstrap/dist/js/bootstrap.min.js'></script>
		<script src='plugins/chart.js/Chart.min.js'></script>
		<script src='dist/js/adminlte.min.js'></script>
		<script defer>
			let username = "siunusdev"; // Set default duco username
			let ducoPrice = 0;
			let lastPrice = 0;
			let lastBalance = 0;
			let lastCounter = 0;
			let priceMax = 0;
			let priceMin = 0;
			let priceAvg = 0;
			let coinsMined = 0;
			let coinsMax = 0;
			let coinsMin = 0;
			let coinsAvg = 0;
			let maxChartData = 15;
			let priceDefaultLabel = [];
			let priceDefaultValue = [];
			let coinsDefaultLabel = [];
			let coinsDefaultValue = [];
			let isStopped = false;
			
			if(location.hash != "") {
				username = location.hash.replaceAll("#", "");
				setUsername(username);
			}
			
			window.onhashchange = function() {
				username = location.hash.replaceAll("#", "");
				setUsername(username);
				
				lastBalance = 0;
				lastCounter = 0;
				
				getJsonData();
				getBalanceData();
			}
			
			if(window.innerWidth < 500) {
				maxChartData = 10;
			}
			
			for(i = 0; i < maxChartData; i++) {
				priceDefaultLabel.push("--:--");
				priceDefaultValue.push(0);
				coinsDefaultLabel.push("--:--");
				coinsDefaultValue.push(0);
			}
			
			let chartPriceData = [];
			let chartPriceConfig = {
				type: 'line',
				data: {
					labels: priceDefaultLabel,
					datasets: [
						{
							label: '$',
							backgroundColor : 'rgba(221, 75, 57, 0.1)',
							borderColor : '#dd4b39',
							borderWidth : 2,
							pointRadius : 1,
							pointHoverRadius : 6,
							pointHitRadius : 10,
							data: priceDefaultValue
						}
					]
				},
				options: {
					responsive: true,
					legend: {
						display: false
					}
				}
			};

			let chartPriceContext = document.getElementById('priceChart').getContext('2d');
			window.priceChart = new Chart(chartPriceContext, chartPriceConfig);
			
			let chartCoinsData = [];
			let chartCoinsConfig = {
				type: 'line',
				data: {
					labels: coinsDefaultLabel,
					datasets: [
						{
							label: 'ᕲ',
							backgroundColor : 'rgba(0, 166, 90, 0.1)',
							borderColor : '#00a65a',
							borderWidth : 2,
							pointRadius : 1,
							pointHoverRadius : 6,
							pointHitRadius : 10,
							data: coinsDefaultValue
						}
					]
				},
				options: {
					responsive: true,
					legend: {
						display: false
					}
				}
			};

			let chartCoinsContext = document.getElementById('coinsChart').getContext('2d');
			window.coinsChart = new Chart(chartCoinsContext, chartCoinsConfig);
			
			function setUsername(u) {
				$('#duco-user').text(u);
			}
			
			function addZero(n) {
				if(n < 10) {
					return "0" + n;
				} else {
					return n;
				}
			}
			
			function setTimebar() {
				let date = new Date();
				let h = date.getHours();
				let m = date.getMinutes();
				let s = date.getSeconds();
				
				$('#time-bar').text(addZero(h) + ":" + addZero(m) + ":" + addZero(s));
				
				setTimeout(setTimebar, 1000);
			}
			
			function updatePriceChart(newLabel, newValue) {
				let chartDataLen = chartPriceConfig.data.datasets[0].data.length;
				let chartDataLast = chartPriceConfig.data.datasets[0].data[chartDataLen - 1];
				
				if(newValue != chartDataLast) {
					chartPriceConfig.data.labels.push(newLabel);
					chartPriceConfig.data.datasets[0].data.push(newValue);
					chartPriceData.push(newValue);
					
					if(chartDataLen >= maxChartData) {
						chartPriceConfig.data.labels.shift();
						chartPriceConfig.data.datasets[0].data.shift();
					}
					
					window.priceChart.update();
				}
			}
			
			function updatePriceMinMax() {
				if($('#price-max').text() == "-") {
					priceMax = ducoPrice;
				}
				
				if($('#price-min').text() == "-") {
					priceMin = ducoPrice;
				}
				
				if(ducoPrice > priceMax) {
					priceMax = ducoPrice;
				}
				
				if(ducoPrice < priceMin) {
					priceMin = ducoPrice;
				}
				
				$('#price-max').text(priceMax);
				$('#price-min').text(priceMin);
			}
			
			function updatePriceAverage() {
				let sum = 0;
				let div = 0;
				let avg = 0;
				
				for(i in chartPriceData) {
					let val = +chartPriceData[i];
					sum += val;
					
					if(val != 0) {
						div++;
					}
				}
				
				if(div != 0) {
					avg = sum / div;
					avg = avg.toFixed(6);
					priceAvg = avg;
				}
				
				$('#price-avg').text(avg);
			}
			
			function updateCoinsChart(newLabel, newValue) {
				let chartDataLen = chartCoinsConfig.data.datasets[0].data.length;
				let chartDataLast = chartCoinsConfig.data.datasets[0].data[chartDataLen - 1];
				
				if(newValue != chartDataLast) {
					chartCoinsConfig.data.labels.push(newLabel);
					chartCoinsConfig.data.datasets[0].data.push(newValue);
					chartCoinsData.push(newValue);
					
					if(chartDataLen >= maxChartData) {
						chartCoinsConfig.data.labels.shift();
						chartCoinsConfig.data.datasets[0].data.shift();
					}
					
					window.coinsChart.update();
				}
			}
			
			function updateCoinsMinMax() {
				if($('#coins-max').text() == "-") {
					coinsMax = coinsMined;
				}
				
				if($('#coins-min').text() == "-") {
					coinsMin = coinsMined;
				}
				
				if(coinsMined > coinsMax) {
					coinsMax = coinsMined;
				}
				
				if(coinsMined < coinsMin) {
					coinsMin = coinsMined;
				}
				
				$('#coins-max').text(coinsMax);
				$('#coins-min').text(coinsMin);
			}
			
			function updateCoinsAverage() {
				let sum = 0;
				let div = 0;
				let avg = 0;
				
				for(i in chartCoinsData) {
					let val = +chartCoinsData[i];
					sum += val;
					
					if(val != 0) {
						div++;
					}
				}
				
				if(div != 0) {
					avg = sum / div;
					avg = avg.toFixed(4);
					coinsAvg = avg;
				}
				
				$('#coins-avg').text(avg);
			}
			
			function getJsonData() {				
				$.ajax({
					dataType: "json",
					url: "https://cors.bridged.cc/http://51.15.127.80/api.json"
				})
				.done(function(data) {
					let statCPU = data["Server CPU usage"];
					let statRAM = data["Server RAM usage"];
					let statConn = data["Active connections"];
					let ctrWorker = data["Active workers"][username];
					let ctrPrice = data["Duco price"];
					let tblMiners = $('#tbl-miners tbody');
					let tblTop10 = $('#tbl-top10 tbody');
					let date = new Date();
					let myMiners = [];
					
					ctrPrice = ctrPrice.toFixed(6);
					ducoPrice = ctrPrice;
					
					updatePriceChart(addZero(date.getHours()) + ":" + addZero(date.getMinutes()), ctrPrice);
					updatePriceMinMax();
					updatePriceAverage();
					
					$('#stat-cpu').text(statCPU + "%");
					$('#stat-ram').text(statRAM + "%");
					$('#stat-conn').text(statConn);
					$('#counter-worker').text(ctrWorker);
					$('#counter-price').html(ctrPrice + " <small>$</small>");
					
					let ctrPriceChange = (ctrPrice - lastPrice);
					if(ctrPriceChange != 0) {
						if(ctrPriceChange != ctrPrice) {
							if(ctrPriceChange > 0) {
								$('#counter-price-change').html("<span class='text-green'><i class='fa fa-caret-up'></i> &nbsp; " + ctrPriceChange.toFixed(6) + " $</span>");
							} else {
								$('#counter-price-change').html("<span class='text-red'><i class='fa fa-caret-down'></i> &nbsp; " + ctrPriceChange.toFixed(6) + " $</span>");
							}
							
							
						}
						lastPrice = ctrPrice;
					}
					
					for (process in data["Miners"]) {
						if (data["Miners"][process]["User"].includes(username)) {
							myMiners.push(data["Miners"][process]);
						}
					}
					
					tblMiners.text('');
					for(miner in myMiners) {
						let tblHTML = "<tr>";
						tblHTML = tblHTML + "<td>" + (+miner+1) + "</td>";
						tblHTML = tblHTML + "<td>" + myMiners[miner]["Software"] + "</td>";
						tblHTML = tblHTML + "<td class='text-info'>" + myMiners[miner]["Sharetime"] + "</td>";
						tblHTML = tblHTML + "<td class='text-green'>" + myMiners[miner]["Accepted"] + "</td>";
						tblHTML = tblHTML + "<td class='text-red'>" + myMiners[miner]["Rejected"] + "</td>";
						tblHTML = tblHTML + "<td class='text-yellow'>" + myMiners[miner]["Hashrate"] + "</td>";
						tblHTML = tblHTML + "<td>" + myMiners[miner]["Diff"] + "</td>";
						tblHTML = tblHTML + "<td>" + myMiners[miner]["Identifier"] + "</td>";
						tblHTML = tblHTML + "<td>" + myMiners[miner]["Last share timestamp"] + " UTC</td>";
						tblHTML = tblHTML + "</tr>";
						
						tblMiners.append(tblHTML);
					}
					
					tblTop10.text('');
					for(position in data["Top 10 richest miners"]) {
						let pos = data["Top 10 richest miners"][position].replaceAll("DUCO", "ᕲ").split("-");
						let topBalance = pos[0].trim();
						let topUsername = pos[1].trim();
						let topWorkers = data["Active workers"][topUsername];
						
						if(topWorkers == undefined) {
							topWorkers = 0;
						}
						
						tblTop10.append("<tr><td>" + (+position+1) + "</td><td>" + topBalance+ "</td><td><a href='#" + topUsername + "'>" + topUsername + "</a></td><td>" + topWorkers + "</td></tr>");
					}
				})
				.fail(function(err) {
					console.log('getJsonData', err);
				})
				.always(function() {
					if(!isStopped) {
						setTimeout(getJsonData, 5 * 1000);
					}
				});
			}
			
			function getBalanceData() {
				$.ajax({
					dataType: "json",
					url: "https://cors.bridged.cc/http://51.15.127.80/balances.json"
				})
				.done(function(data) {
					let ctrBalance = data[username];
					let balanceStr = ctrBalance.split(" ");
					let balance = +balanceStr[0];
					let ctrDollar = balance * ducoPrice;
					let date = new Date();
					
					$('#counter-balance').html(balance.toFixed(4) + " <small>ᕲ</small>");
					$('#counter-dollar').text("~" + ctrDollar.toFixed(2) + " $");
					
					if(balance > lastBalance) {
						let newCounter = date.getTime() / 1000;
						let changedInSec = 3600 / (newCounter - lastCounter);
						let balChanged = (balance - lastBalance);
						let estInHours =  balChanged * changedInSec;
						let ctrEstimated = estInHours * 24;
						
						if(balChanged != balance) {
							coinsMined = balChanged.toFixed(4);
							updateCoinsChart(addZero(date.getHours()) + ":" + addZero(date.getMinutes()) + ":" + addZero(date.getSeconds()), balChanged.toFixed(6));
							updateCoinsMinMax();
							updateCoinsAverage();
						}
					
						if(lastBalance == 0) {
							$('#counter-estprofit').html("<small>Calculating...</small>");
						} else {
							$('#counter-estprofit').html("~" + ctrEstimated.toFixed(4) + " <small>ᕲ</small>");
						}
						
						lastBalance = balance;
						lastCounter = newCounter;
					}
				})
				.fail(function(err) {
					console.log('getBalanceData', err);
				})
				.always(function() {
					if(!isStopped) {
						setTimeout(getBalanceData, 5 * 1000);
					}
				});
			}
			
			function getTransactions() {
				$.ajax({
					dataType: "json",
					url: "https://cors.bridged.cc/http://51.15.127.80/transactions.json"
				})
				.done(function(data) {
					let transactions = [];
					let tblTransaction = $('#tbl-transactions tbody');
					
					for(index in data) {
						transactions.push(data[index]);
					}
					
					tblTransaction.text('');
					for(i = 1; i <=10; i++) {
						let t = transactions[transactions.length - i];
						let dateTime = t["Date"] + " - " + t["Time"];
						let sender = t["Sender"];
						let recipient = t["Recipient"];
						let amount = t["Amount"];
						
						tblTransaction.append("<tr><td>" + i + "</td><td><small>" + dateTime + "</small></td><td><a href='#" + sender + "'>" + sender + "</a></td><td><a href='#" + recipient + "'>" + recipient + "</a></td><td>" + amount + "</td></tr>");
					}
				})
				.fail(function(err) {
					console.log('getTransactions', err);
				})
				.always(function() {
					if(!isStopped) {
						setTimeout(getTransactions, 10 * 1000);
					}
				});
			}
			
			$(document).ready(function() {
				setUsername(username);
				setTimebar();
				getJsonData();
				getBalanceData();
				getTransactions();
			});
			
		</script>
	</body>
</html>
